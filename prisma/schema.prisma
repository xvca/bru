generator client {
  provider               = "prisma-client"
  output                 = "../generated/prisma"
  generatedFileExtension = "ts"
  importFileExtension    = "ts"
  runtime                = "nodejs"
}

datasource db {
  provider = "sqlite"
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String
  createdAt DateTime @default(now()) @map("created_at")

  defaultBarId   Int? @map("default_bar_id")
  decafStartHour Int  @default(23) @map("decaf_start_hour")

  brews          Brew[]
  beans          Bean[]
  grinders       Grinder[]
  brewers        Brewer[]
  barMemberships BrewBarMember[]
  deviceTokens   DeviceToken[]

  @@map("users")
}

model Bean {
  id              Int       @id @default(autoincrement())
  batchId         String?   @map("batch_id")
  name            String
  roaster         String?
  origin          String?
  roastLevel      String?   @map("roast_level")
  roastDate       DateTime  @map("roast_date")
  freezeDate      DateTime? @map("freeze_date")
  thawDate        DateTime? @map("thaw_date")
  initialWeight   Float     @map("initial_weight")
  remainingWeight Float?    @map("remaining_weight")
  notes           String?
  process         String?
  producer        String?

  createdBy Int  @map("created_by")
  user      User @relation(fields: [createdBy], references: [id])

  barId   Int?     @map("bar_id")
  brewBar BrewBar? @relation(fields: [barId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  brews     Brew[]

  regularBeanForBars BrewBar[] @relation("DefaultRegularBean")
  decafBeanForBars   BrewBar[] @relation("DefaultDecafBean")

  @@index([batchId])
  @@map("beans")
}

model Grinder {
  id       Int     @id @default(autoincrement())
  name     String
  burrType String? @map("burr_type")
  notes    String?

  createdBy Int  @map("created_by")
  user      User @relation(fields: [createdBy], references: [id])

  barId   Int?     @map("bar_id")
  brewBar BrewBar? @relation(fields: [barId], references: [id])

  brews Brew[]

  @@map("grinders")
}

model Brewer {
  id    Int     @id @default(autoincrement())
  name  String
  type  String
  notes String?

  createdBy Int  @map("created_by")
  user      User @relation(fields: [createdBy], references: [id])

  barId   Int?     @map("bar_id")
  brewBar BrewBar? @relation(fields: [barId], references: [id])

  brews Brew[]

  @@map("brewers")
}

model BrewBar {
  id        Int      @id @default(autoincrement())
  name      String
  location  String?
  createdBy Int      @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")

  defaultRegularBeanId Int? @map("default_regular_bean_id")
  defaultDecafBeanId   Int? @map("default_decaf_bean_id")

  members BrewBarMember[]

  beans    Bean[]
  brewers  Brewer[]
  grinders Grinder[]

  brews Brew[]

  deviceTokens       DeviceToken[]
  defaultRegularBean Bean?         @relation("DefaultRegularBean", fields: [defaultRegularBeanId], references: [id])
  defaultDecafBean   Bean?         @relation("DefaultDecafBean", fields: [defaultDecafBeanId], references: [id])

  @@map("brew_bars")
}

model BrewBarMember {
  id     Int     @id @default(autoincrement())
  barId  Int     @map("bar_id")
  userId Int     @map("user_id")
  role   String?
  bar    BrewBar @relation(fields: [barId], references: [id])
  user   User    @relation(fields: [userId], references: [id])

  @@unique([barId, userId])
  @@map("brew_bar_members")
}

model Brew {
  id     Int @id @default(autoincrement())
  userId Int @map("user_id")
  beanId Int @map("bean_id")

  method String

  grinderId Int? @map("grinder_id")

  brewerId Int? @map("brewer_id")

  barId Int? @map("bar_id")

  doseWeight       Float    @map("dose_weight")
  yieldWeight      Float?   @map("yield_weight")
  brewTime         Int?     @map("brew_time")
  grindSize        Float?   @map("grind_size")
  waterTemperature Float?   @map("water_temperature")
  bloomTime        Int?     @map("bloom_time")
  rating      Int?     @default(0)
  notes       String?
  autoCreated Boolean  @default(false) @map("auto_created")
  createdAt        DateTime @default(now()) @map("created_at")

  user    User     @relation(fields: [userId], references: [id])
  bean    Bean     @relation(fields: [beanId], references: [id])
  grinder Grinder? @relation(fields: [grinderId], references: [id])

  brewer Brewer? @relation(fields: [brewerId], references: [id])

  brewBar BrewBar? @relation(fields: [barId], references: [id])

  @@map("brews")
}

model DeviceToken {
  id         Int      @id @default(autoincrement())
  token      String   @unique
  barId      Int      @map("bar_id")
  createdBy  Int      @map("created_by")
  deviceName String?  @map("device_name")
  createdAt  DateTime @default(now()) @map("created_at")
  lastUsedAt DateTime @default(now()) @map("last_used_at")

  brewBar BrewBar @relation(fields: [barId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@map("device_tokens")
}
